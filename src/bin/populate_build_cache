#!/bin/bash

function usage {
cat << EOF
Usage: $0 [-m MIRRORPATH]

Options
    -j, --jobs      number of concurrent pkgs to cache (default 1)
    -m, --mirror    specify a custom path to a mirror

EOF
exit
}

if [[ " $@ " == *" -h "* ]] || [[ " $@ " == *" --help "* ]]; then
    usage
fi

# Perform common script setup including environment checks
export my_dir="$( cd "$(dirname "$0")" ; pwd )"
. $my_dir/tools/init.sh

while [[ $# -gt 0 ]]; do
    case $1 in
        -j|--jobs)
            if [[ $1 == *=* ]]; then
                max_jobs=${1#*=}
            else
                max_jobs=$2; shift
            fi
            ;;
        -m|--mirror)
            if [[ $1 == *=* ]]; then
                mirror_path=${1#*=}
            else
                mirror_path=$2; shift
            fi
            ;;
        *)
            >&2 echo "Error: unrecognized option $1"
            usage
            exit 1
            ;;
    esac

    shift
done

log_dir=$SPACK_ENV/logs
mkdir -p $log_dir
log_file=$log_dir/cache.$start_time
cache_cmd="spack buildcache create -a"

if [[ $NCAR_SPACK_DEPLOY_TYPE == production ]]; then
    mirror_path=${mirror_path:-$NCAR_SPACK_MIRROR_GLOBAL}
else
    mirror_path=${mirror_path:-$NCAR_SPACK_MIRROR_LOCAL}
fi

# Job tracking by PIDs
declare -A job_pids

function wait_for_jobs {
    while [[ ${#job_pids[@]} -eq $1 ]]; do
        for jp in ${!job_pids[@]}; do
            if ! kill -0 $jp 2> /dev/null; then
                unset job_pids[$jp]
            fi
        done
    done
}

tsecho "Using up to ${max_jobs:-1} threads to populate cache"

pkglist=$(spack find -L -p | awk -v envpath=${SPACK_ENV}/opt '$3~envpath { print $1 }')
cachelist=$(ls $mirror_path/build_cache/ 2> /dev/null || true)

for pkg in $pkglist; do
    if [[ $cachelist != *$pkg* ]]; then
        use_cache=$(awk -F: -v spec_hash="$pkg" '$2 == spec_hash {print $3}' .installs)

        if [[ $use_cache != no ]]; then
            pkg_label=$(spack find --no-groups -f --show-full-compiler -v /$pkg | tail -n1)
            tsecho "Caching package:  ${GCOL}$pkg_label${DCOL}"
            log_cmd "$cache_cmd -d $mirror_path --only=package /$pkg" >> $log_file
            $cache_cmd -d $mirror_path --only=package /$pkg &>> $log_file &
            job_pids[$!]=running
        fi
    fi
    
    wait_for_jobs ${max_jobs:-1}
done

wait_for_jobs 1
