#!/bin/bash

function usage {
cat << EOF
Usage: $0 [-m MIRRORPATH]

Options
    -m, --mirror    specify a custom path to a mirror

EOF
exit
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--mirror)
            mirror_path=$2
            shift
            ;;
        -h|--help)
            usage
            exit
            ;;
        *)
            echo "Error: unrecognized option $1"
            usage
            exit 1
            ;;
    esac

    shift
done

# Perform common script setup including environment checks
export my_dir="$( cd "$(dirname "$0")" ; pwd )"
. $my_dir/tools/init.sh

pkglist=$(spack find -L -p | awk -v envpath=${SPACK_ENV}/opt '$3~envpath { print $1 }')
cachelist=$(ls ${mirror_path:-$NCAR_SPACK_MIRROR}/build_cache/ 2> /dev/null)

for pkg in $pkglist; do
    if [[ $cachelist != *$pkg* ]]; then
        pkg_label=$(spack find --no-groups -f --show-full-compiler -v /$pkg | tail -n1)
        echo -e "\n==> Creating binary package for: $pkg_label"
        spack buildcache create -a -d ${mirror_path:-$NCAR_SPACK_MIRROR} --only=package /$pkg
    fi
done
