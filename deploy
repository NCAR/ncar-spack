#!/bin/bash
#
#   This script is used to deploy a new "build" environment based on
#   a specified cluster definition. 
#
#   Author:         Brian Vanderwende
#   Last Revised:   19:08, 28 Sep 2022
#

set -e
export NCAR_SPACK_DEPLOY_TIME=$(date +%y%m%dT%H%M)
export NCAR_SPACK_DEPLOY_DIR="$( cd "$(dirname "$0")" ; pwd )"
export NCAR_SPACK_DEPLOY_TYPE=testing

#
## ---- INITIALIZATION ----
#

# Handle arguments
user_args=( "$@" )

while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
        --no-pkgs|--nopkgs)
            skip_pkgs=yes
            ;;
        -p|--production)
            NCAR_SPACK_DEPLOY_TYPE=production
            ;;
        *)
            export NCAR_SYS=$1
            ;;
    esac

    shift
done

if [[ -z $NCAR_SYS ]]; then
>&2 cat << EOF
Error:  deployment configuration must be specified!
Usage:  $0 [--no-pkgs] [-p] CONFIG

EOF
exit 1
elif [[ ! -f $NCAR_SPACK_DEPLOY_DIR/clusters/$NCAR_SYS/main.cfg ]]; then
>&2 cat << EOF
Error:  deployment "$NCAR_SYS" not recognized from available options

EOF
exit 1
fi

# Source cluster settings
. $NCAR_SPACK_DEPLOY_DIR/clusters/$NCAR_SYS/main.cfg

# Check if Github repo exists
if [[ -n $NCAR_SPACK_GITHUB ]] && [[ $skip_github != yes ]]; then
    echo -e "Checking status of $NCAR_SPACK_GITHUB ...\n"
    
    if ! git ls-remote -h "$NCAR_SPACK_GITHUB"; then
        exit 1
    fi
fi

#
## ---- INSTALL/CLONE SPACK FOR CLUSTER ----
#

spack_clone_path=$NCAR_SPACK_ROOT_DEPLOYMENT/spack

if [[ $NCAR_SPACK_ROOT != $spack_clone_path ]]; then 
    if [[ -d $NCAR_SPACK_ROOT_DEPLOYMENT ]]; then
        >&2 echo "Error:  Existing deployment found at ${NCAR_SPACK_ROOT_DEPLOYMENT}. Will not"
        >&2 echo -e "        overwrite. Resolve and rerun this script.\n"
        exit 1
    fi

    # Install latest source from GitHub and checkout specified version
    echo "Installing Spack into $spack_clone_path ..."
    git clone -c feature.manyFiles=true https://github.com/spack/spack.git $spack_clone_path
    cd $spack_clone_path
    git checkout $NCAR_SPACK_CLONE_VERSION

    # Apply source code patches as necessary
    if [[ -d $NCAR_SPACK_DEPLOY_DIR/src/patches/$NCAR_SPACK_CLONE_VERSION ]]; then
        for src_patch in $NCAR_SPACK_DEPLOY_DIR/src/patches/$NCAR_SPACK_CLONE_VERSION/*; do
            echo "Applying patch to Spack: $src_patch"
            git apply $src_patch &> /dev/null
        done
    fi

    # Copy scripts to Spack install
    cp -r $NCAR_SPACK_DEPLOY_DIR/src/spack/* $spack_clone_path/
    sed -i "s/%HOST%/$NCAR_SPACK_HOST/g" $spack_clone_path/bin/clean_bash

    # Add custom cluster source files if found
    if [[ -d $NCAR_SPACK_DEPLOY_DIR/clusters/$NCAR_SYS/src/spack ]]; then
        cp -r $NCAR_SPACK_DEPLOY_DIR/clusters/$NCAR_SYS/src/spack/* $spack_clone_path/
    fi

    if [[ -n $NCAR_SPACK_PYDIR ]]; then
        sed -i "/^env_args=/a NCAR_SPACK_PYDIR=$NCAR_SPACK_PYDIR" $spack_clone_path/bin/clean_bash
    fi

    # Modify permissions according
    chgrp -R csgteam $spack_clone_path
    chmod -R a=rX,u+w $spack_clone_path

    # Activate spack installation
    . $spack_clone_path/share/spack/setup-env.sh

    # Create trusted GPG key in spack install
    echo -e "\nCreating trusted GPG key for build cache creation ..."
    spack gpg create "NCAR BUILD Spack" "<csg@ucar.edu>"

    # Make sure environment is clean
    cd $NCAR_SPACK_DEPLOY_DIR
    $spack_clone_path/bin/clean_bash $0 "${user_args[@]}"
    exit $?
else
    # Activate spack installation
    . $NCAR_SPACK_STARTUP
fi

#
## ---- CREATE AND CUSTOMIZE ENV ----
#

if [[ -d $NCAR_SPACK_ENV_BUILD ]]; then
>&2 cat << EOF
Error:  Existing environment found at ${NCAR_SPACK_ENV_BUILD}. Will not
        overwrite. Resolve and rerun this script.

EOF
exit 1
fi

echo "Creating env at $NCAR_SPACK_ENV_BUILD ..."

# All spack needs for an env is a directory with spack.yaml
mkdir -p $NCAR_SPACK_ENV_BUILD/logs
cp clusters/$NCAR_SYS/spack.yaml $NCAR_SPACK_ENV_BUILD
cp -r src/env/* $NCAR_SPACK_ENV_BUILD

cat > $NCAR_SPACK_ENV_BUILD/main.cfg << EOF
NCAR_SPACK_DEPLOY_TYPE=$NCAR_SPACK_DEPLOY_TYPE
NCAR_SPACK_DEPLOY_COMMIT=$(git rev-parse HEAD)

EOF

envsubst '$USER,$NCAR_SYS' < clusters/$NCAR_SYS/main.cfg >> $NCAR_SPACK_ENV_BUILD/main.cfg
cp clusters/$NCAR_SYS/packages.cfg $NCAR_SPACK_ENV_BUILD
cp clusters/$NCAR_SYS/externals.cfg $NCAR_SPACK_ENV_BUILD
cp -r templates $NCAR_SPACK_ENV_BUILD

if [[ -d clusters/$NCAR_SYS/templates ]]; then
    cp -r clusters/$NCAR_SYS/templates $NCAR_SPACK_ENV_BUILD
fi

if [[ -f clusters/$NCAR_SYS/postprocess ]]; then
    cp clusters/$NCAR_SYS/postprocess $NCAR_SPACK_ENV_BUILD/bin
fi

# Add relevant paths to spack.yaml
sed -i "s|%DEPLOYMENT%|${NCAR_SPACK_HOST}/$NCAR_SPACK_HOST_VERSION|" $NCAR_SPACK_ENV_BUILD/spack.yaml
sed -i "s|%INSTALLROOT%|${NCAR_SPACK_ENV_BUILD}/opt|" $NCAR_SPACK_ENV_BUILD/spack.yaml
sed -i "s|%MODULESROOT%|${NCAR_SPACK_ENV_BUILD}/modules/$NCAR_SPACK_HOST_VERSION|" $NCAR_SPACK_ENV_BUILD/spack.yaml
sed -i "s|%VIEWROOT%|${NCAR_SPACK_ENV_BUILD}/ncarenv|" $NCAR_SPACK_ENV_BUILD/spack.yaml
sed -i "s|%TMPDIR%|$NCAR_SPACK_TMPDIR|g" $NCAR_SPACK_ENV_BUILD/spack.yaml

# Activate the environment
spack env activate $NCAR_SPACK_ENV_BUILD
spack env status

# Add externals from initial config file
$NCAR_SPACK_ENV_BUILD/bin/add_externals

# Detect available external compilers (e.g., Cray compilers)
if [[ ${NCAR_SPACK_DETECT_COMPILERS:-false} == true ]]; then
    spack compiler find
fi

# Create mirror and prepare workshop to generate build_cache (binaries)
spack config add "config:install_tree:padded_length:${NCAR_SPACK_PAD_LENGTH:-128}"

if [[ -d $NCAR_SPACK_MIRROR/build_cache/_pgp ]]; then
    for gpg_key in $NCAR_SPACK_MIRROR/build_cache/_pgp/*.pub; do
        spack gpg trust $gpg_key
    done
else
    spack mirror create -d $NCAR_SPACK_MIRROR -a
    spack gpg publish -d $NCAR_SPACK_MIRROR
fi

spack mirror add $NCAR_SPACK_MIRROR_NAME $NCAR_SPACK_MIRROR

# Add custom repos
if [[ -f clusters/$NCAR_SYS/repos.cfg ]]; then
    mkdir -p $SPACK_ENV/repos

    while read -r repo; do
        if [[ -f $NCAR_SPACK_DEPLOY_DIR/repos/$repo/setup.sh ]]; then
            . $NCAR_SPACK_DEPLOY_DIR/repos/$repo/setup.sh
        else
            cp -r $NCAR_SPACK_DEPLOY_DIR/repos/$repo $SPACK_ENV/repos
            spack repo add $SPACK_ENV/repos/$repo
        fi
    done < clusters/$NCAR_SYS/repos.cfg
fi

# Add NCAR templates
spack config add "config:template_dirs:$SPACK_ENV/templates/modules"

#
## ---- BUILD PACKAGES IN ENVIRONMENTS ----
#

if [[ ${skip_pkgs:-no} != yes ]]; then
    echo -e "Building packages in build environment ...\n"
    # Build packages from source in build environment
    cd $NCAR_SPACK_ENV_BUILD
    bin/install_packages

    # Run script to populate the binary build_cache
    echo -e "Populating build cache with package binaries ...\n"
    bin/populate_build_cache

    # Create modules in build environment
    if [[ -n $NCAR_SPACK_ROOT_MODULES ]]; then
        echo "Generating modules in build environment ..."
        spack module lmod refresh -y
    fi

    # Some clusters (e.g., Cray) need to run extra commands to prep environment
    if [[ -f $NCAR_SPACK_ENV_BUILD/bin/postprocess ]]; then
        echo "Running postprocessing on the build environment ..."
        $NCAR_SPACK_ENV_BUILD/bin/postprocess
    fi
fi

spack env deactivate

# Status message
cat << EOF

===========================
    DEPLOYMENT COMPLETE
===========================

Machine:        $NCAR_SYS
Date:           $NCAR_SPACK_DEPLOY_TIME
Type:           $NCAR_SPACK_DEPLOY_TYPE

Spack root:     $SPACK_ROOT
Build root:     $NCAR_SPACK_ENV_BUILD
Public root:    $NCAR_SPACK_ENV_PUBLIC

Github repo:    $NCAR_SPACK_GITHUB

EOF

if [[ ${skip_pkgs:-no} != yes ]]; then
cat << EOF
Install logs:   $NCAR_SPACK_ENV_BUILD/logs/installs.$NCAR_SPACK_DEPLOY_TIME
Caching logs:   $NCAR_SPACK_ENV_BUILD/logs/cache.$NCAR_SPACK_DEPLOY_TIME

EOF
fi

cat << EOF
*** First check that builds in build environment are valid! ***

To install into $NCAR_SPACK_DEPLOY_TYPE public environment, run the following:

$NCAR_SPACK_ENV_BUILD/bin/publish "Initial deployment of environment on $NCAR_SYS"

EOF
