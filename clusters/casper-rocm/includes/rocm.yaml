packages:
  adios2:
    variants:
    - +rocm
  all:
    prefer:
    - +rocm
    - amdgpu_target=gfx942
  hip:
    require:
    - +rocm
  hwloc:
    prefer:
    - +rocm
    require:
    # This is a GLIBCXX symbol versioning requirement for ROCm 6.4.3
    - spec: '%gcc@14:'
      when: +rocm %gcc
  intel-oneapi-compilers:
    variants:
    - +amd
  kokkos:
    require:
    - spec: +rocm +wrapper ~alloc_async
      when: '%gcc'
    - spec: +rocm +apu +wrapper ~alloc_async
      when: '%aocc'
    - spec: ^cmake@3.27
      when: '@:4.2.01 +rocm'
  llvm:
    require:
    # This is necessary because otherwise ROCm bits get included into the
    # llvm header and lib paths and may break the installation
    - ^hwloc~rocm
  ncarcompilers:
    variants:
    - +hip
  nvtop:
    require:
    - support:=amd
  openmpi:
    require:
    - +rocm
    - amdgpu_target=gfx942
    - spec: '%gcc@14:'
      when: +rocm %gcc
  osu-micro-benchmarks:
    variants:
    - +rocm
  rocblas:
    prefer:
    - +tensile
    - amdgpu_target=gfx942
  rocfft:
    prefer:
    - amdgpu_target=gfx942
    - amdgpu_target_sram_ecc=gfx942
  rocprofiler-systems:
    require:
    - ~internal-dyninst
    - +rocm
    - +perfetto_tools
    - +python
  ucx:
    require:
    - +rocm
    - spec: '%gcc@14:'
      when: +rocm %gcc
modules:
  default:
    lmod:
      projections:
        rocm-core: rocm/{version}
      rocm-core:
        template: ncar_wrapper_hip.lua
        environment:
          set:
            HSA_XNACK: '1'
            NCAR_INC_HIPRAND2: '{prefix.include}/hiprand'
          append_path:
            CMAKE_PREFIX_PATH: '{prefix}/llvm'
            LD_LIBRARY_PATH: '{prefix}/llvm/lib'
            PATH: '{prefix}/llvm/bin'
