#!/bin/bash

set -e

function popmsg {
cat << EOF

=====
$1
=====

EOF
}

function spec_install {
    popmsg "INSTALL: $1"
    echo -e "\nspack spec -I -N $1:\n"
    spack spec -I -N $1
    echo -e "\nspack install $1:\n"
    spack install $1
}

if [[ -z $SPACK_ENV ]]; then
    2>&1 echo "Error: no Spack environment detected!"
    exit 1
fi

while read PKG; do
    PKGTYPE=$(cut -d' ' -f1  <<< $PKG)
    PKGSPEC=$(cut -d' ' -f2- <<< $PKG)

    case $PKGTYPE in
        singleton*)
            spec_install $PKGSPEC
            ;;
        cdep*)
            for CMP in $CMPLIST; do
                DEPSPEC=$(sed "s|%CMP%|$CMP|;t;s|$| $CMP|" <<< "$PKGSPEC")
                spec_install $DEPSPEC
            done
            ;;
        mdep*)
            for CMP in $CMPLIST; do
                for MPI in $MPILIST; do
                    DEPSPEC=$(sed "s|%CMP%|$CMP|;t;s|$| $CMP|" <<< "$PKGSPEC")
                    DEPSPEC=$(sed "s|%MPI%|$MPI|;t;s|$| $MPI|" <<< "$DEPSPEC")
                    spec_install $DEPSPEC
                done
            done
            ;;
        *)
            echo -e "\n====="
            echo "Error: unrecognized package type: $PKGTYPE"
            echo "       halting installs at $PKGSPEC ..."
            exit 1
            ;;
    esac
    
    if [[ $PKGTYPE == *-compiler ]]; then
        popmsg "REGISTER: $PKGSPEC ==> COMPILER"
        CMPLIST="$CMPLIST %$PKGSPEC"

        if [[ $PKGSPEC == gcc* ]]; then
            spack compiler add $(spack location -i $PKGSPEC)
        fi
    elif [[ $PKGTYPE == *-mpi ]]; then
        popmsg "REGISTER: $PKGSPEC ==> MPI LIBRARY"
        MPILIST="$MPILIST ^$PKGSPEC"
    fi
done < $1
