# Site Customizations
Spack allows for many customizations to be made to the base install and environments via YAML files. This page will describe the customizations employed in these scripts for NCAR software stacks. Full details on YAML options are available in [this doc page](https://spack.readthedocs.io/en/latest/configuration.html).

## Global Settings
The Spack installation itself can be customized via the following YAML files:

-   [compilers.yaml](https://spack.readthedocs.io/en/latest/getting_started.html#compiler-config)
-   [config.yaml](https://spack.readthedocs.io/en/latest/config_yaml.html#config-yaml)
-   [mirrors.yaml](https://spack.readthedocs.io/en/latest/mirrors.html#mirrors)
-   [modules.yaml](https://spack.readthedocs.io/en/latest/module_file_support.html#modules)
-   [packages.yaml](https://spack.readthedocs.io/en/latest/build_settings.html#build-settings)
-   [repos.yaml](https://spack.readthedocs.io/en/latest/repositories.html#repositories)

These settings will apply at all times when this spack binary is used, including when environments are active (unless the environment overrides a setting or category of settings). Currently, we only modify one setting in the main `config.yaml` file, which sets the maximum number of build jobs to 10.

### User environment settings
Note that the above file structure can be repeated in a user's home directory under `~/.spack`. This can be a convenience, but it also allows for user settings (sometimes autogenerated) to contaminate commands in unexpected ways. The environments set up by this repository are configured to override any user settings.

## Environment customizations
### Paths
In the spack.yaml file, the following paths are configured (`$SPACK_ENV` is the root directory of the environment):
- install_tree -> root = $SPACK_ENV/opt - this is where the software will actually be installed
- module_roots -> lmod = $SPACK_ENV/modules - the root directory for the module tree

The setting `padded_length` is added in the build environment only. Spack can create relocatable binaries of compiled installs, which can be reinstalled into a different environment or Spack instance. Since certain hard-coded paths can only be shrunk, not expanded, Spack will pad the path to the install with a specified number of characters to account for any long paths that may be used in the future. *The padded path is cumbersome, and should not be enabled in any public environments!*

### Path projections
Spack generates paths to installs and modules by *projecting* attributes onto a directory structure. By default, Spack will differentiate software installs by a long hash code. This is quite different than our hierarchical directory structure, but can be reconfigured. To avoid silent clobbering of existing installs, we do keep a short hash at the end of the install directories.

### Package preferences and externals
The packages section specifies certain known preferences, which will affect default behavior when a package is listed in a spec. For example, we default Open MPI to use PBS integration, and default NetCDF to build serially. Cluster-specific settings are given here too, such as default compiler and target architecture.

This section also defines a number of "external" packages, ones that Spack detects in the OS environment. In general, it's helpful to include many OS packages, as this reduces duplication and avoids Spack wanting to build some libraries with compilers known to fail.

### Modules
In this section, we configure Spack to use lmod with a two tier hierarchy. Implicit packages are ignored when modules are created (e.g., we don't need a openssl module). By default, Spack would include hash codes in module names, but this is disabled.

An important concept here is the *core compiler*, which is set to the OS compiler. All software build with this compiler will form the base level of the module tree (the core level), and so we want to use the system compiler so that custom GCC versions are visible, and also because we have vendor compilers use the system GCC as their base compilers.

Some software are also listed as *core_specs*, which simply means that they should appear in the "core" category even if they were compiled with a non-OS compiler.

### The `ncar.hpcd` repository
Spack provides a `builtin` repository of packages that contains thousands of package install recipes. It should be used if possible. However, there are some packages that are unique to NCAR (e.g., compiler wrappers; gufiwrappers), and so a custom repository named `ncar.hpcd` is added to our environments.

Unfortunately, some packages may also need editing to support unique features/quirks on our systems. The `ncar.hpcd` repository should take precedence over `builtin` in these cases, but it's good to check with `spack spec -N`. Be careful about superseding common packages like *mpi* providers and compilers, as future changes can cause whole segments of the software tree to be rebuilt.
